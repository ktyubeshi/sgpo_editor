# SGPOエディタ 実装計画詳細

以下は、各機能要件に対する詳細な実装計画です。

## 0. ファサードパターンとEntryModelクラス移行の完了

### 実装計画
1. **EntryModelクラスへの移行**
   - [x] EntryModelクラスを実装し、既存のEntryクラスを置き換える
   - [x] ファサードクラス（EntryEditorFacade, EntryListFacade）を実装
   - [x] メタデータパネルのエラーを修正（get_all_metadataメソッド対応）
   - [x] メタデータダイアログのエラーを修正（get_all_metadataメソッド対応）
   - [x] table_manager.pyのEntryクラス参照を確認・修正
   - [x] ViewerPOFileクラスのEntryModel対応
   - [x] 全ファイルでのインポート文の確認（EntryからEntryModelへ）
   - [x] 型アノテーションの確認（EntryからEntryModelへ）
   - [x] テストコードの確認・修正

2. **ドキュメント更新**
   - [x] クラス図の更新（ファサードパターンとEntryModelクラスを反映）
   - [x] API仕様書の更新
   - [x] 開発者向けガイドの更新

3. **テスト強化**
   - [x] ファサードクラスのテストケース追加
   - [x] EntryModelクラスの機能をカバーするテストケース追加
   - [x] エッジケースや異常系のテスト追加

## 1. エントリリストの列幅を可変にする

### 実装計画
1. **UI設計**
   - [x] QTableWidgetのヘッダーにリサイズハンドルを追加する
   - [x] 列幅の変更をユーザー操作で可能にする
   - [x] 列幅の設定を保存・復元する仕組みを構築する

2. **設定の永続化**
   - [x] TableManagerクラスに列幅設定を保存する機能を追加する
   - [x] アプリケーション終了時に列幅設定を保存する
   - [x] アプリケーション起動時に列幅設定を読み込む

3. **実装対象ファイル**
   - [x] `src/sgpo_editor/gui/table_manager.py`の`_setup_table`メソッドを修正する
   - [x] 現在の固定列幅設定（QHeaderView.ResizeMode.Fixed）を可変に変更
   - [x] 列幅保存用の設定ファイル形式と保存場所を決定する

4. **テスト**
   - [x] 列幅変更が正しく動作するかテストする
   - [x] アプリケーション再起動後も列幅設定が保持されるかテストする

## 2. エントリリストに表示する列を変更可能にする

### 実装計画
1. **設定UI実装**
   - [x] 列表示設定ダイアログを作成する
   - [x] チェックボックスでの列表示/非表示切り替え機能を実装
   - [x] 列の表示順変更機能を実装（上下移動ボタンなど）

2. **列管理機能実装**
   - [x] TableManagerクラスに表示列設定を管理する機能を追加
   - [x] エントリから取得可能な全列の定義一覧を作成
   - [x] 表示列設定に基づいてテーブル構造を動的に変更する機能を実装

3. **設定の永続化**
   - [x] 表示列設定をJSON形式で保存する機能を実装
   - [x] アプリケーション起動時に設定を読み込む機能を実装

4. **メニュー統合**
   - [x] メインウィンドウのメニューに「列表示設定」メニュー項目を追加
   - [x] メニュー選択で列表示設定ダイアログを表示する機能を実装

5. **実装対象ファイル**
   - [x] `src/sgpo_editor/gui/table_manager.py`を修正
   - [x] 列表示設定ダイアログ用の新規クラスを作成
   - [x] `src/sgpo_editor/gui/main_window.py`にメニュー項目を追加

## 3. エントリリストにScore列を追加可能にする

### 実装計画
1. **UI拡張**
   - [x] テーブルのヘッダー定義にScore列を追加する
   - [x] Score列の表示形式は数値とする

2. **テーブル管理機能拡張**
   - [x] TableManagerクラスにScore列のデータ管理機能を追加
   - [x] Score値に基づいた行の色分け表示機能を実装（オプション）
   - [x] Scoreによるソート機能を実装

3. **実装対象ファイル**
   - [x] `src/sgpo_editor/gui/table_manager.py`のカラム定義を修正
   - [x] Score列の表示・ソート処理を実装

4. **項目4と連携**
   - [x] 内部データモデルのScore実装と連携させる

## 4. 内部データのモデルにもScoreを追加する

### 実装計画
1. **モデル拡張**
   - [x] EntryModelクラスにscore属性を追加
   - [x] scoreの初期値、範囲、型定義を決定（数値型）

2. **APIインターフェース**
   - [x] スコア設定・取得用のAPIメソッドを実装
   - [x] スコア変更時のイベント通知仕組みを実装

3. **実装対象ファイル**
   - [x] `src/sgpo_editor/models/entry.py`のEntryModelクラスを修正
   - [x] POファイル操作関連クラスを修正

## 5. エントリには任意のメタデータを追加できるようにする(ユーザ定義)

### 実装計画
1. **モデル拡張**
   - [x] EntryModelクラスに汎用メタデータ辞書フィールドを追加
   - [x] メタデータの型定義（キー・値ペアの設計）を決定
   - [x] メタデータ操作APIを設計・実装

2. **メタデータUI**
   - [x] メタデータ編集ダイアログを設計・実装
   - [x] キー・値のカスタム入力機能を実装
   - [x] メタデータテンプレート機能を実装（オプション）

3. **永続化**
   - [x] POファイル内でのメタデータ保存方法を設計（コメント活用など）
   - [x] ファイル保存時にメタデータも保存する機能を実装
   - [x] ファイル読み込み時にメタデータを復元する機能を実装

4. **実装対象ファイル**
   - [x] `src/sgpo_editor/models/entry.py`のEntryModelクラスを修正
   - [x] `src/sgpo_editor/utils/metadata_utils.py`を新規作成し、メタデータ操作ユーティリティを実装
   - [x] メタデータ編集用のダイアログクラスを新規作成 (`src/sgpo_editor/gui/metadata_dialog.py`)
   - [x] POファイル操作関連クラスの修正（EntryModelのto_po_entryメソッドの実装）

## 6. エントリのメタデータを表示するための専用ウィンドウを追加する

### 実装計画
1. **UI設計と実装**
   - [x] メタデータ表示用パネルを設計・実装
   - [x] カスタム表示フォーマットを実装（ツリー形式）
   - [x] 表示・非表示の切り替え機能を実装

2. **トリガー機能実装**
   - [x] エントリ選択時のメタデータ表示更新機能を実装
   - [x] ショートカットキーでのメタデータパネル表示機能を実装（オプション）
   - [x] メインウィンドウにメタデータメニューを追加

3. **メタデータ表示ロジック**
   - [x] 現在選択中のエントリのメタデータを取得する機能を実装
   - [x] メタデータのツリー表示形式を実装
   - [x] メタデータの印刷・エクスポート機能を実装（オプション）

4. **実装対象ファイル**
   - [x] メタデータ表示用パネルクラスを作成 (`src/sgpo_editor/gui/metadata_panel.py`)
   - [x] `src/sgpo_editor/gui/main_window.py`に統合する
   - [x] エントリ選択時のメタデータ表示更新機能を実装

## 7. LLMを利用した翻訳品質評価機能を追加する

### 実装計画
1. **データモデル設計**
   - [x] 翻訳評価状態を管理する列挙型（未評価/評価中/評価済）を定義
   - [x] 総合スコアフィールドを追加（エントリリストのGUIと整合）
   - [x] 評価指標ごとのスコアを格納する辞書フィールドを追加
   - [x] 複数言語のレビューコメントを格納するデータ構造を設計・実装
   - [x] EntryModelクラスに上記フィールドを追加

2. **インターフェース設計**
   - [x] エントリ単位でアクセスするためのインターフェースを実装
   - [x] エントリの評価状態を管理するインターフェースを実装
   - [x] スコア・レビューコメント設定のためのインターフェースを実装
   - [ ] 全エントリにアクセスするための一括取得インターフェースを実装

3. **UI設計**
   - [ ] 「ツール」メニューに「翻訳の品質評価」メニュー項目を追加
   - [ ] 翻訳評価実行ダイアログを設計・実装
   - [ ] 評価状態の視覚的表示機能を実装
   - [ ] 評価結果表示用UIを設計・実装
   - [ ] 多言語レビューコメント表示・切り替え機能を実装

4. **LLM連携機能実装**
   - [ ] LLMサービスとの連携インターフェースを実装
   - [ ] 翻訳評価プロンプトテンプレートを設計
   - [ ] 様々な評価指標に基づく品質評価方法の実装
   - [ ] 評価結果のパース処理を実装
   - [ ] 評価結果から総合スコアと指標別スコアを算出する機能を実装

5. **データベース設計と実装**
   - [ ] SQLiteデータベースのスキーマを設計
     - [ ] エントリ識別用テーブル（msgctxtとmsgidの組み合わせをキー）
     - [ ] 評価状態管理テーブル
     - [ ] 総合スコアテーブル
     - [ ] 評価指標別スコアテーブル
     - [ ] 多言語レビューコメントテーブル
   - [ ] POファイルのサイドカーとしてのDBファイル管理機能を実装
   - [ ] msgctxtとmsgidの組み合わせをキーとした関連付け機能を実装

6. **データ永続化**
   - [ ] 評価結果をSQLiteに保存する機能を実装
   - [ ] POファイルを開く際にサイドカーDBを読み込む機能を実装
   - [ ] DBが存在しない場合のスキップ処理を実装
   - [ ] 評価状態の変更を即座にDBに反映する機能を実装

7. **スコア連携**
   - [ ] 評価結果からスコアを算出する機能を実装
   - [ ] スコアをEntryModelに反映する機能を実装
   - [ ] テーブル表示のScore列と連携させる
   - [ ] スコアに基づくエントリのフィルタリング・ソート機能を実装

8. **実装対象ファイル**
   - [x] `src/sgpo_editor/models/entry.py`に評価関連フィールドを追加
   - [x] 評価状態管理用の列挙型を定義する新規ファイルを作成
   - [ ] 評価インターフェースを実装する新規ファイルを作成
   - [ ] `src/sgpo_editor/gui/main_window.py`にメニュー項目を追加
   - [ ] 翻訳評価ダイアログ用の新規クラスを作成
   - [ ] LLM連携用の新規モジュールを作成
   - [ ] データベース操作用の新規モジュールを作成

## 実装順序と優先度

1. **第1段階（基盤整備）**:
   - [x] 内部データモデルにScoreを追加（項目4）
   - [x] LLMを利用した翻訳品質評価機能の基盤実装（項目7のデータモデル・インターフェース設計部分）
   - [x] エントリに任意のメタデータを追加できるようにする（項目5）
   - [x] エントリのメタデータを表示するための専用パネルを追加する（項目6）

2. **第2段階（UI拡張）**:
   - [x] エントリリストの列幅を可変にする（項目1）
   - [x] エントリリストに表示する列を変更可能にする（項目2）
   - [ ] LLM翻訳評価のUI実装（項目7のUI設計部分）

3. **第3段階（機能統合）**:
   - [x] エントリリストにScore列を追加（項目3）
   - [x] メタデータ表示用パネルの追加（項目6）
   - [ ] 翻訳品質評価機能の完成（項目7のLLM連携・DB実装部分）

## テスト計画

各機能実装後に以下のテストを実施:

1. **ユニットテスト**
   - [x] 評価状態の列挙型のテストを作成
   - [x] EntryModelの評価関連フィールドのテストを作成
   - [x] メタデータ操作APIのテストケースを作成 (`test_entry_metadata.py`)
   - [x] メタデータのUIテストを作成 (`test_metadata_ui.py`)
   - [x] 列の表示・非表示機能のテストを作成 (`test_table_manager_column_visibility.py`, `test_column_visibility_gui.py`)
   - [x] Score列の表示機能のテストを作成 (`test_table_manager.py`)
   - [x] テーブルのステータス表示機能のテストを作成 (`test_table_status_display.py`)
   - [x] エントリステータス機能のテストを作成 (`test_entry_status.py`)
   - [ ] LLM翻訳評価機能のテストを作成
   - [ ] データベース操作のテストケースを作成
   - [ ] LLM連携機能のモックテストを作成
   - [ ] 翻訳評価インターフェースのテストを作成
   - [ ] 多言語レビューコメント機能のテストを作成

2. **機能テスト**
   - [x] 列幅変更と設定保存・読み込みのテスト
   - [x] 表示列の変更と設定保存・読み込みのテスト
   - [x] Score表示・ソート機能のテスト
   - [x] メタデータ追加・表示・保存機能のテスト
   - [ ] 翻訳品質評価機能の実行テスト
   - [ ] サイドカーDBの保存・読み込みテスト
   - [ ] エントリの評価状態管理機能のテスト
   - [ ] 多言語レビューコメントの表示・切り替えテスト

3. **実行コマンド**
   ```
   # すべてのテストを実行
   uv run pytest
   
   # 特定のテストファイルを実行
   uv run pytest tests/test_entry_metadata.py
   
   # テストケースの詳細を表示して実行
   uv run pytest tests/test_metadata_ui.py -v
   
   # 関連するテストファイルをまとめて実行
   uv run pytest tests/test_main_window_*.py -v
   ```

## 次に取り組む要件

1. **バグ修正: Applyボタン機能の修正**
   - [x] EntryEditorクラスにデータベースを設定する処理を追加
   - [x] MainWindowクラスの_on_entry_updatedメソッドを修正
   - [x] TableManagerとEntryListFacadeのテーブル更新処理を強化
   - [x] デバッグログを追加して処理の流れを追跡しやすくする

2. **項目7: LLM翻訳品質評価機能のUI実装**
   - 翻訳評価ダイアログクラスを新規作成する
   - メインウィンドウに翻訳評価発行用のメニュー項目とボタンを追加する
   - 評価結果の表示・管理機能を実装する
   - テストコードを作成し、500行程度を上限として適切に分割する
   - 実装対象ファイル：
     - `src/sgpo_editor/gui/translation_evaluate_dialog.py` (新規)
     - `src/sgpo_editor/gui/main_window.py`
     - `src/sgpo_editor/gui/ui_setup.py`
     - `tests/test_translation_evaluation.py` (新規)

3. **作業順序**
   1. [x] Applyボタン機能の修正を完了
   2. 次にLLM翻訳品質評価機能のUI部分を実装
   3. 各機能の実装後にはテストを作成し、`uv run pytest` でテストを実行
   4. 最後に全体的な統合テストを実施